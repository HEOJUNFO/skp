<template>
  <div class="frame" :style="frameStyle">
    <div v-if="isCapturing" class="countdown">{{ countdown }}</div>
    <div class="top-bar" :style="barStyle" v-show="isBarVisible" >
        <button v-if="!isCapturing" @click="toggleAspectRatio">
          <span v-if="aspectRatio ===0">3:4</span>
          <span v-else-if="aspectRatio ===1">1:1</span>
          <span v-else-if="aspectRatio ===2">9:16</span>
          <span v-else-if="aspectRatio ===3">FUll</span>
          <span v-else-if="aspectRatio ===4">출력사이즈</span>
        </button>
        <button v-if="timerButtonVisible && !isCapturing " @click="toggleTimer">
          <span v-if="timerButtonVisible === 2">타이머3</span>
          <span v-else-if="timerButtonVisible === 3">타이머5</span>
          <span v-else-if="timerButtonVisible === 4">타이머7</span>
          <span v-else-if="timerButtonVisible=== 1">타이머X</span>
        </button>       
        <button v-if="!isCapturing" @click="flipCamera">카메라전환</button>
        <button v-if="!isCapturing" @click="openExitModal">나가기</button>
      </div>
    <iframe ref="iframeRef" :src="`${baseUrl}/ar.html#/frame`" frameborder="0"></iframe>
    <div v-if="!isSecondFrameBarVisible && isBarVisible" class="bottom-bar-1" :style="barStyle">
      <button v-if="!isCapturing" @click="frameToggleBar">프레임</button>
      <button v-if="!isCapturing" @touchstart="startLongPress" @touchend="cancelLongPress" @click="capture">촬영</button>
      <button v-if="isCapturing" @click="stopCapture" class="capture-button">타이머 촬영 종료</button>
      <button v-if="!isCapturing" @click="effectToggleBar">이펙트</button>
    </div>
    <div v-if="isSecondFrameBarVisible && isBarVisible " class="bottom-bar-2" :style="barStyle">
      <div class="tab-container">
        <button class="tab" 
                v-for="tab in frameTabs" 
                :key="tab.id"
                :class="{ selected: selectedTab === tab.id }"
                @click="selectTab(tab.id)">{{ tab.name }}</button>
      </div>
      <div class="image-container">
        <div class="image-view" 
        v-for="image in getImagesForSelectedTab(frameImages)" 
        :key="image.id"
        :class="{ selected: image.select }">  <!-- 선택된 이미지에 클래스를 적용 -->
        <img :src="image.src" @click="selectImage(frameImages,image.id)"/>
        <span>{{ image.name }}</span>
        </div>
      </div>
      <div class="button-container">
        <button @click="frameToggleBar">나가기</button>
        <button v-if="!isCapturing" @touchstart="startLongPress" @touchend="cancelLongPress" @click="capture">촬영</button>
        <button v-if="isCapturing" @click="stopCapture" class="capture-button">타이머 촬영 종료</button>
      </div>
    </div>
    <div v-if="isSecondEffectBarVisible && isBarVisible " class="bottom-bar-2" :style="barStyle">
      <div class="tab-container">
        <button class="tab" 
                v-for="tab in effectTabs" 
                :key="tab.id"
                :class="{ selected: selectedTab === tab.id }"
                @click="selectTab(tab.id)">{{ tab.name }}</button>
      </div>
      <div class="image-container">
        <div class="image-view" 
        v-for="image in getImagesForSelectedTab(effectImages)" 
        :key="image.id"
        :class="{ selected: image.select }">  <!-- 선택된 이미지에 클래스를 적용 -->
        <img :src="image.src" @click="selectImage(effectImages,image.id)"/>
        <span>{{ image.name }}</span>
        </div>
      </div>
      <div class="button-container">
        <button @click="effectToggleBar">나가기</button>
        <button v-if="!isCapturing" @touchstart="startLongPress" @touchend="cancelLongPress" @click="capture">촬영</button>
        <button v-if="isCapturing" @click="stopCapture" class="capture-button">타이머 촬영 종료</button>
      </div>
    </div>
  </div>
 </template>

<script>
import {ref, computed, watch} from "vue";
import { useRouter } from 'vue-router'

  export default {
    name: "Frame",
    setup() {
      const router = useRouter();
      const iframeRef = ref(null);
      const isSecondFrameBarVisible = ref(false);
      const isSecondEffectBarVisible = ref(false);
      const isBarVisible = ref(false);
      const aspectRatio = ref(0);
      const aspectRatioValue = ref('3 / 4');
      const selectedTab = ref(1);

      const longPressTimer = ref(null);
      const timerButtonVisible = ref(0);
      const isCapturing = ref(false);
      const countdown = ref(null);
      const countdownInterval = ref(null);

      const frameTabs = ref([
      { id: 1, name: '축제1' },
      { id: 2, name: '축제2' },
      { id: 3, name: '축제3' },
    ]);
    
    const frameImages = ref([
      { id: 1, tabId:1, src: '/path/to/image1', name: 'Image 1',select: true },
      { id: 2, tabId:1, src: '/path/to/image2', name: 'Image 2' ,select: false},
      { id: 3, tabId:1, src: '/path/to/image3', name: 'Image 3',select: false },
      { id: 4, tabId:1, src: '/path/to/image4', name: 'Image 4', select:false },
      { id: 5, tabId:2, src: '/path/to/model1', name: 'Model 1',select: true },
      { id: 6, tabId:2, src: '/path/to/model2', name: 'Model 2' ,select: false},
      { id: 7, tabId:2, src: '/path/to/model3', name: 'Model 3',select: false },
      { id: 8, tabId:2, src: '/path/to/model4', name: 'Model 4', select:false },
    ]);

    const effectTabs = ref([
      { id: 1, name: '모델' },
      { id: 2, name: '이펙트' },
      { id: 3, name: '필터' },
    ]);
    
    const effectImages = ref([
      { id: 1, tabId:1, src: '/path/to/image1', name: 'model 1',select: true },
      { id: 2, tabId:1, src: '/path/to/image2', name: 'model 2' ,select: false},
      { id: 3, tabId:1, src: '/path/to/image3', name: 'model 3',select: false },
      { id: 4, tabId:1, src: '/path/to/image4', name: 'model 4', select:false },
      { id: 5, tabId:2, src: '/path/to/model1', name: 'effect 1',select: true },
      { id: 6, tabId:2, src: '/path/to/model2', name: 'effect 2' ,select: false},
      { id: 7, tabId:2, src: '/path/to/model3', name: 'effect 3',select: false },
      { id: 8, tabId:2, src: '/path/to/model4', name: 'effect 4', select:false },
    ]);

      const toggleAspectRatio = () => {
        aspectRatio.value = (aspectRatio.value + 1) % 5
        if(aspectRatio.value === 0){
          aspectRatioValue.value = '3 / 4'
        } else if(aspectRatio.value === 1){
          aspectRatioValue.value = '1 / 1'
        } else if(aspectRatio.value === 2){
          aspectRatioValue.value = '9 / 16'
        } else if(aspectRatio.value === 3){
          aspectRatioValue.value = '1 / 2'
          if (iframeRef.value) {
            iframeRef.value.contentWindow.containTopValueToggle();
        }
        } else if(aspectRatio.value === 4){
          aspectRatioValue.value = '814 / 1218'
          if (iframeRef.value) {
            iframeRef.value.contentWindow.containTopValueToggle();
        }
        }
        };

      const frameStyle = computed(() => ({
      aspectRatio: aspectRatioValue.value,
      }));

      const barStyle = computed(() => ({
        backgroundColor: aspectRatio.value ===3 ? 'rgba(255, 255, 255, 0)' : 'rgba(255, 255, 255, 1)',
        }));

       window.toggleBarVisibility = function() {
      isBarVisible.value = !isBarVisible.value;
      };

      const flipCamera = () => {
        if (iframeRef.value) {
            iframeRef.value.contentWindow.flipCamera();
        }
      };

      const openExitModal = () => {
        if (iframeRef.value) {
            iframeRef.value.contentWindow.openExitModal();
        }
      };

      const startLongPress = () => {
        longPressTimer.value = setTimeout(() => {
          timerButtonVisible.value = 1;
        }, 1000);
      }

      const cancelLongPress = () => {
        clearTimeout(longPressTimer.value);
      }

      const toggleTimer = () => {
        timerButtonVisible.value = (timerButtonVisible.value + 1) % 5;
        if(timerButtonVisible.value === 0) {
          timerButtonVisible.value = 1;
        }
      }

      const capture = async () => {
        if (timerButtonVisible.value === 0) {
        // No timer, just capture immediately
        await captureImage();
      } else {
        isCapturing.value = true;
        countdown.value = [ 0, 0,3, 5, 7][timerButtonVisible.value];

        countdownInterval.value = setInterval(async() => {
            countdown.value -= 1;
            if (countdown.value <= 0) {
              await captureImage();
              stopCapture();
        }
      }, 1000);
      }
    };

      const stopCapture = () => {
        clearInterval(countdownInterval.value);
        isCapturing.value = false;
      };

      const captureImage = async () => {
        if(isCapturing.value || timerButtonVisible.value === 0){
                let captureurl = '';
                if (iframeRef.value) {
                    captureurl = await iframeRef.value.contentWindow.capture();
                }
                router.push({ name: 'Print Open Browser', params: { data: captureurl } });
            }
      
      };

      const frameToggleBar = () => {
      isSecondFrameBarVisible.value = !isSecondFrameBarVisible.value;
    }
    const effectToggleBar = () => {
      isSecondEffectBarVisible.value = !isSecondEffectBarVisible.value;
    }

    const selectTab = (tabId) => {
      selectedTab.value = tabId;
    
    }

    const getImagesForSelectedTab = (images) => {

  return images.filter(image => image.tabId === selectedTab.value);
}

const selectImage = (images, imageId) => {
  images.forEach(image => {
    if (image.tabId === selectedTab.value) {
      image.select = (image.id === imageId);
    }
  });
}
const frameTabIds = frameTabs.value.map(tab => tab.id);

for (let tabId of frameTabIds) {
    const selectedFrameImage = computed(() => 
        frameImages.value.find(image => image.tabId === tabId && image.select === true)
    );

    watch(selectedFrameImage, (newImage, oldImage) => {
        if (newImage !== oldImage && newImage !== null) {
          newImage.id = newImage.id % 4 === 0 ? 4 : newImage.id % 4
            iframeRef.value.contentWindow.selectFrame(newImage.id);
        }
    });
}

const effectTabIds = effectTabs.value.map(tab => tab.id);

for (let tabId of effectTabIds) {
    const selectedEffectImage = computed(() => 
        effectImages.value.find(image => image.tabId === tabId && image.select === true)
    );

    watch(selectedEffectImage, (newImage, oldImage) => {
        if (newImage !== oldImage && newImage !== null) {
          newImage.id = newImage.id % 4 === 0 ? 4 : newImage.id % 4
            iframeRef.value.contentWindow.selectModel(newImage.id);
        }
    });
}

      return {
        baseUrl: process.env.VUE_APP_PAGE_PATH
        , iframeRef
        , toggleAspectRatio
        , flipCamera
        , openExitModal
        , isSecondFrameBarVisible
        , isSecondEffectBarVisible
        , frameToggleBar
        , effectToggleBar
        , capture
        , isBarVisible
        , frameStyle
        , barStyle
        , frameTabs
        , frameImages
        , effectTabs
        , effectImages
        , selectTab
        , getImagesForSelectedTab
        , selectImage
        , selectedTab
        , stopCapture
        , captureImage
        , isCapturing
        , startLongPress
        , cancelLongPress
        , toggleTimer
        , timerButtonVisible
        , countdown
        , aspectRatio
     
      }
    }
  }
  </script>
  
  <style scoped>
.frame {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: auto;
  background: #f9f9f9;
}
  
.top-bar, .bottom-bar-1, .bottom-bar-2 {
  z-index: 1;
  position: absolute;
  width: 100%;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 10px;
  color: #fff;
}

.bottom-bar-1, .bottom-bar-2 {
  bottom: -40px;
}

.bottom-bar-2{
  flex-direction: column;
}

.tab-container {
  display: flex;
  justify-content: center; 
  width: 100%;
  margin-bottom: 20px;
}
  
.image-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  width: 100%;
  margin-bottom: 20px;
}

.image-view {
  display: flex;
  flex-direction: column;
  align-items: center;
  color : #000;
}

.button-container {
  display: flex;
  justify-content: space-around;
  width: 100%;
}

.tab.selected {
  background-color: #ccc;
}

.tab {
    margin: 0 35px;
}

.image-view.selected {
  border: 2px solid blue; 
}

.countdown {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 3em;
  color: #fff;
  z-index: 2;
}
  </style>