<template>
  <div class="event-wrapper" :style="eventWrapperStyles" @mousedown="disableClick ? toggleBottomBar() : null">
    <slot></slot>
    <div v-if="arFrameSettingYn && loadingState === 'COMPLETE'" @mousedown="disableClick ? toggleBottomBar() : null"
      class="frame-top" :style="{ 'backgroundImage': `url(${frameUrl})`, 'top': `${0}px` }">
    </div>
    <div v-if="arFrameSettingYn && loadingState === 'COMPLETE'" class="frame-bottom"
      :style="{ 'backgroundImage': `url(${frameUrl})` }"></div>
    <div v-if="loadingYn && loadingState !== 'COMPLETE'" class="ArPhotoloading">
      <img :src="loadingUrl" alt="로딩 이미지">
      <div class="progress-bar">
        <div class="progress-bar-fill" :style="{ width: `${progressValue}%` }"></div>
      </div>
      <p class="text">AR 준비중</p>
    </div>
  </div>
  <!-- 가로모드 -->
  <div class="landscape_wrap" v-if="orientation !== 'portrait'">
    <p>가로모드 지원안함</p>
  </div>
</template>
  
<script>
import { computed, ref, inject, onMounted, watchEffect, provide } from "vue";
import { useStore } from "vuex";

import useLoading from "@/composables/useLoading";
import uesOrientation from "@/composables/uesOrientation";

export default {
  name: "Container",
  setup() {
    const store = useStore();
    const { getters } = store;
    const orientation = ref('landscape')
    const disableClick = ref(false);
    const progressValue = ref(0);

    const selectFrame = ref(1);
    const frameUrl = computed(() => {
      const frameInfo = getters['eventData/frameContentsInfoList'][selectFrame.value - 1];
      return frameInfo ? frameInfo.sourceUri : '';
    });

    const loadingYn = computed(() => {
      const isLoading = store.getters['eventData/loadingImgYn'];
      return isLoading === 'Y';
    });

    const loadingUrl = computed(() => {
      const url = store.getters['eventData/loadingImgUrl'];
      return String(url);
    });

    const arFrameSettingYn = computed(() => {
      const isArFrameSetting = store.getters['eventData/arFrameSettingYn'];
      return isArFrameSetting === 'Y';
    });

    const {
      loadingState,
    } = useLoading()

    const {
      checkOrientation
    } = uesOrientation()

    // 가로 세로 체크
    const setOrientation = (str) => {
      orientation.value = str;
      if (str === 'portrait') {
        document.body.classList.remove('landscape');
      } else {
        document.body.classList.add('landscape');
      }
    }
    checkOrientation(setOrientation);


    const toggleBottomBar = inject('toggleBottomBar');

    let intervalId;

    watchEffect(() => {
      if (loadingState.value === 'COUNTING' || loadingState.value === 'LOADING') {
        intervalId = setInterval(() => {
          if (progressValue.value < 100) {
            progressValue.value += 2;
          } else {
            clearInterval(intervalId);
          }
        }, 1);
      } else if (loadingState.value === 'COMPLETE') {
        clearInterval(intervalId);
        progressValue.value = 100;
      } else {
        clearInterval(intervalId);
        progressValue.value = 0;
      }
    });

    const eventWrapperStyles = ref({
      top: '8vh',
      height: '77vh',
      width: '100%'
    });

    const setEventWrapperStyles = (newTop, newWidth, newHeight) => {
      eventWrapperStyles.value.top = newTop;
      eventWrapperStyles.value.width = newWidth;
      if (newHeight !== 'nullpx') {
        eventWrapperStyles.value.height = newHeight;
      }
    }

    provide('setEventWrapperStyles', setEventWrapperStyles);


    onMounted(() => {
      setTimeout(() => {
        disableClick.value = true;
      }, 2000)
    })

    return {
      frameUrl,
      loadingYn,
      loadingUrl,
      disableClick,
      orientation,
      loadingState,
      arFrameSettingYn,
      selectFrame,
      toggleBottomBar,
      progressValue,
      eventWrapperStyles,
      setEventWrapperStyles
    }
  }
}
</script>
  
<style scoped>
.event-wrapper {
  z-index: 1;
  width: 100%;
  height: 69vh;
  position: relative;
  top: 14vh;
  background-color: #fff;
}

.text {
  position: absolute;
  top: calc(20vh + 400px);
  left: 50%;
  transform: translateX(-50%);
  color: #000;
  text-align: center;
  font-family: NanumSquare Neo OTF;
  font-size: 18px;
  font-style: normal;
  font-weight: 400;
  line-height: 140%;
}

.ArPhotoloading .progress-bar {
  position: absolute;
  top: calc(20vh + 380px);
  left: 50%;
  transform: translateX(-50%);
  width: 72%;
  height: 1.5vh;
  background-color: #d9d9d9;
  border-radius: 50px;
}

.ArPhotoloading .progress-bar .progress-bar-fill {
  height: 100%;
  background-color: #eb4747;
  transition: width 0.2s;
  border-radius: 50px;
}

.ArPhotoloading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /*background:#000;opacity:0.6;*/
  background: #fff;
  z-index: 6;
}

.ArPhotoloading img {
  position: absolute;
  top: 20vh;
  left: 50%;
  width: auto;
  height: auto;
  -webkit-transform: translate(-50%, 0%);
  z-index: 8;
}
</style>